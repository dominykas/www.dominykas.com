<!DOCTYPE html>
<html dir="ltr" lang="en-US">
<head>
	<meta charset="UTF-8" />

	<title>
		 &raquo; Opera Extensions: messaging example - dominykas.com			</title>

	<meta name="generator" content="WordPress 2.9.2" /> <!-- leave this for stats -->

	<link rel="stylesheet" href="http://www.dominykas.com/wp-content/themes/dominykas.com.5/style.css" type="text/css" />
	<link rel="pingback" href="http://www.dominykas.com/xmlrpc.php" />
	<link rel="alternate" type="application/rss+xml" title="dominykas.com &raquo; Feed" href="http://www.dominykas.com/index.rss2.xml" />
<link rel="alternate" type="application/rss+xml" title="dominykas.com &raquo; Comments Feed" href="http://www.dominykas.com/comments.rss2.xml" />
<link rel="alternate" type="application/rss+xml" title="dominykas.com &raquo; Opera Extensions: messaging example Comments Feed" href="http://www.dominykas.com/2010/11/opera-extensions-messaging-example.rss2.xml" />
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://www.dominykas.com/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://www.dominykas.com/wp-includes/wlwmanifest.xml" /> 
<link rel='index' title='dominykas.com' href='http://www.dominykas.com' />
<link rel='start' title='Hello world!' href='http://www.dominykas.com/2009/12/hello-world.html' />
<link rel='prev' title='(Solved) troubles with Ubuntu, VirtualBox, OpenVZ/Proxmox and MySQL' href='http://www.dominykas.com/2010/05/solved-troubles-with-ubuntu-virtualbox-openvzproxmox-and-mysql.html' />
<link rel='next' title='DublinJS August meetup kata' href='http://www.dominykas.com/2011/08/dublinjs-august-meetup-kata.html' />
<meta name="generator" content="WordPress 2.9.2" />
<link rel='canonical' href='http://www.dominykas.com/2010/11/opera-extensions-messaging-example.html' />

	<link rel="openid.server" href="http://openid.claimid.com/server" />
	<link rel="openid.delegate" href="http://openid.claimid.com/dominykas" />

<!--[if IE]>
<script src="http://www.dominykas.com/wp-content/themes/dominykas.com.5/images/html5.js" type="text/javascript"></script>
<![endif]-->

</head>
<body><div id="page">

<header role="banner" id="banner">
	<hgroup>
		<h1><a href="http://www.dominykas.com/">dominykas.com</a></h1>
		<h2>I&#039;d like to someday write a book about asking the right questions</h2>
	</hgroup>
</header>

<nav id="sidebar">

			<section id="recent-posts-2" class="widget widget_recent_entries">		<h1>Recent Posts</h1>		<ul>
				<li><a href="http://www.dominykas.com/2014/01/but-its-easy.html" title="But it&#8217;s easy&#8230;">But it&#8217;s easy&#8230; </a></li>
				<li><a href="http://www.dominykas.com/2012/04/omg-omg-nielsen-is-wrong-lets-all-like-build-responsive-sites.html" title="OMG OMG Nielsen is wrong, let&#8217;s all, like, build responsive sites">OMG OMG Nielsen is wrong, let&#8217;s all, like, build responsive sites </a></li>
				<li><a href="http://www.dominykas.com/2011/08/dublinjs-august-meetup-kata.html" title="DublinJS August meetup kata">DublinJS August meetup kata </a></li>
				<li><a href="http://www.dominykas.com/2010/11/opera-extensions-messaging-example.html" title="Opera Extensions: messaging example">Opera Extensions: messaging example </a></li>
				<li><a href="http://www.dominykas.com/2010/05/solved-troubles-with-ubuntu-virtualbox-openvzproxmox-and-mysql.html" title="(Solved) troubles with Ubuntu, VirtualBox, OpenVZ/Proxmox and MySQL">(Solved) troubles with Ubuntu, VirtualBox, OpenVZ/Proxmox and MySQL </a></li>
				<li><a href="http://www.dominykas.com/2010/04/just-how-much-does-performance-matter.html" title="Just how much does performance matter?">Just how much does performance matter? </a></li>
				<li><a href="http://www.dominykas.com/2010/01/benchmark-html-outlining-toc-scripts.html" title="Benchmark: HTML outlining/TOC scripts">Benchmark: HTML outlining/TOC scripts </a></li>
				<li><a href="http://www.dominykas.com/2009/12/asp-net-mvc-generates-invalid-clientids.html" title="ASP.NET MVC generates invalid ClientIDs">ASP.NET MVC generates invalid ClientIDs </a></li>
				<li><a href="http://www.dominykas.com/2009/12/javascript-void-must-die.html" title="javascript:void(0) must die">javascript:void(0) must die </a></li>
				<li><a href="http://www.dominykas.com/2009/12/hello-world.html" title="Hello world!">Hello world! </a></li>
				</ul>
		</section><section id="linkcat-8" class="widget widget_links"><h1>My other stuff</h1>
	<ul class='xoxo blogroll'>
<li><a href="http://code.google.com/p/h5o/" rel="me">HTML5 outliner in JS</a></li>
<li><a href="http://www.d-b.lt/" rel="me">Lietuviškai</a></li>
<li><a href="http://code.dominykas.com/" rel="me">Some JS/CSS/PHP code</a></li>
<li><a href="http://twitter.com/dymonaz" rel="me">Twitter</a></li>

	</ul>
</section>
<section id="text-4" class="widget widget_text">			<div class="textwidget"><div style="text-align:center;"><a href='https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array' title='JS Array index'><img src='http://static.jsconf.us/promotejsv.gif' height='280' width='160' alt='JS Array index'/></a></div></div>
		</section><section id="linkcat-2" class="widget widget_links"><h1>Blogroll</h1>
	<ul class='xoxo blogroll'>
<li><a href="http://foobarpig.com/" rel="friend met">foobarpig.com</a></li>

	</ul>
</section>
<section id="meta-3" class="widget widget_meta"><h1>Meta</h1>			<ul>
						<li><a href="http://www.dominykas.com/wp-login.php">Log in</a></li>
			<li><a href="http://www.dominykas.com/index.rss2.xml" title="Syndicate this site using RSS 2.0">Entries <abbr title="Really Simple Syndication">RSS</abbr></a></li>
			<li><a href="http://www.dominykas.com/comments.rss2.xml" title="The latest comments to all posts in RSS">Comments <abbr title="Really Simple Syndication">RSS</abbr></a></li>
			<li><a href="http://wordpress.org/" title="Powered by WordPress, state-of-the-art semantic personal publishing platform.">WordPress.org</a></li>
						</ul>
</section><section id="text-3" class="widget widget_text">			<div class="textwidget"><p style="text-align:center;"><a href="http://www.zend.com/store/education/certification/authenticate.php?ClientCandidateID=ZEND001268&amp;RegistrationID=220103242" title="Verify authenticity"><img src="http://dominykas.net/images/php5_zce_logo.gif" alt="Zend Certified Engineer (PHP5)" border="0" /></a></p></div>
		</section>
</nav>
<section id="content" role="main">

	
	    <article class="post singular" id="post-117">
	<header class="clearfix">
		<h1><a href="http://www.dominykas.com/2010/11/opera-extensions-messaging-example.html" rel="bookmark">Opera Extensions: messaging example</a></h1>
		<ul>
			<li><time datetime="2010-11-04T01:08:33+00:00">November 4, 2010</time></li>
					</ul>
	</header>
	
	<div class="postbody">
	<p>I already <a href="http://twitter.com/dymonaz/status/29608503399">vented out</a> my <a href="http://dev.opera.com/forums/topic/793632">frustration with examples that have flaws</a>, so this one is more constructive and tries to actually explain and solve things. You&#8217;re welcome to skip all of that and just <a href="http://code.dominykas.com/opera-extensions/title_in_popup.oex">get the example code</a>.</p>
<p>It may not be 100% correct, it may have it&#8217;s own flaws, and obviously it may soon become obsolete, as Opera 11 is still in alpha, but I did create a more reliable example of how to communicate between the user scripts and popup windows.</p>
<p>This article assumes you already grok the <a href="http://dev.opera.com/articles/view/getting-started-with-opera-extensions/">introductory information on Opera extension</a>. In fact, knowledge of Chrome extension flows may also help.<br />
<span id="more-117"></span></p>
<h2>The flaws</h2>
<p>Let&#8217;s skip the ranting about lack of documentation (hint hint) and look at the fundamental flaws in the original <a href="http://dev.opera.com/articles/view/opera-extensions-messaging/#popup_injectedscript">Communicating between popup and injected script</a> example. You can download <a href="http://code.dominykas.com/opera-extensions/message_example3/message_example3_modified.oex">the modified version of it</a> that attempts to display the page title. I also documented the steps to <a href="http://code.dominykas.com/opera-extensions/message_example3/readme.txt">reproduce two bugs</a> in it.</p>
<ol>
<li>There is only one communication channel &#8211; and it&#8217;s always reset to the page which was loaded last.</li>
<li>The above means, that we may not be communicating with the focused tab.</li>
<li>The above also means that the channel is not re-established once a new popup opens &#8211; even if it&#8217;s on the same tab. I suspect that <code>if (port)</code> is supposed to check whether the channel is still active, but (potentially &#8211; due to a browser bug) it returns a truthy value, hence the new channel is not sent to the popup.</li>
<li>The check inside <code>onconnect</code> only validates that a communication channel was created &#8211; it never validates that the connecting script is actually a popup window</li>
</ol>
<h2>The solution</h2>
<p>In here, I have a couple of things that are merely assumptions on how things work, and how the API should respond &#8211; this is mostly due to lack of documentation (hint hint, again) and is based on experience with Chrome extensions.</p>
<p>The core point of the solution is to <strong>avoid storing the communication channel in the background script</strong> &#8211; instead &#8211; store a reference to the popup window. I feel that it is safe to do, since the popup window closes automatically, and it seems that all data associated with it gets destroyed.</p>
<p>The background script still plays an important role &#8211; it&#8217;s job is to pass the <code>MessagePort</code> from the user script to the popup, but it only does that when requested. As mentioned above, when the popup window closes, we also need to re-establish the connection, so the final flow becomes like this:</p>
<ol>
<li>Browser loads, background script is initialized</li>
<li>A page in a tab loads, user script gets initialized</li>
<li>User clicks on the toolbar icon for the popup</li>
<li>The popup loads</li>
<li>Background page receives an <code>onconnect</code> event</li>
<li>It then checks the event origin &#8211; all widget related files have URLs that start with <code>widget://</code></li>
<li>If the thing that just connected is a popup window, the background script determines the active tab, and sends a <code>getPorts</code> message to initiate messaging connection. It also stores the reference to the popup for future communication.</li>
<li>The user script receives the message and creates a new communication channel (it assumes that the previous channel is long dead)</li>
<li>It then sends that communication channel back to the background script using <code>establishConnection</code> message.</li>
<li>The background script forwards that message to the previously stored popup reference. I feel that it is safe enough to trust that, since the steps 5-9 should really be pretty much instantaneous without any user interaction possible in between.</li>
<li>The popup receives the communication channel &#8211; it is free to do with it whatever it likes, e.g. request information from the user script using <code>postMessage()</code> and receive that information using <code>onmessage</code>.
<li>Once the popup closes, we end up at point 2</li>
</ol>
<p><a href="http://code.dominykas.com/opera-extensions/title_in_popup.oex">Download example code</a> (I release it into public domain, without any guarantees)</p>
<h2>The gotchas, suggestions and pleas to the Opera team</h2>
<h3>Document <code>MessageChannel</code> and <code>MessagePort</code></h3>
<p>While this is an obvious request, I&#8217;d also like to mention that I find Chrome&#8217;s model of two way messaging much simpler &#8211; just pass around a callback function for each message.</p>
<h3>Rename <code>port1</code> and <code>port2</code> to something meaningful</h3>
<p>My initial response to these two properties was that one of them is for sending messages, the other is for receiving. As far as I understand that right now &#8211; one is to be used as a &#8220;local&#8221; communication port, and the other is for the use by &#8220;remote&#8221; script. They should be named accordingly. However, a much better approach would be to not expose them at all &#8211; same as the previous suggestion &#8211; it should be possible to just create a <code>MessageChannel</code> with <code>postMessage()</code> and <code>onmessage</code> &#8211; which are inversed once they change context.</p>
<h3>Clarify if objects are allowed as <code>event.data</code></h3>
<p>I&#8217;ll admit &#8211; I didn&#8217;t read the W3C spec. My example uses simple objects, but the <a href="http://labs.opera.com/extensions-api/">API documentation</a> says the message data has to be a <code>DOMString</code>. While it&#8217;s not a biggie, and I&#8217;m sure everyone is good friends with <code>JSON.stringify()</code> and <code>JSON.parse()</code>, it either should be documented as allowed or should throw errors when used.</p>
<h3>Create an easier way to determine who is the <code>event.origin</code></h3>
<p>At the moment, to check if the message was sent by a popup, I&#8217;m testing the URL in the <code>event.origin</code>, but I&#8217;d really like to see some methods, such as <code>isBackgroundScript()</code>, <code>isUserScript()</code> and <code>isPopup()</code> for simplicity.</p>
<h3>More graphical information</h3>
<p>I&#8217;m guilty here, since I probably should have included the flow diagram instead of an 11 point list in this blog, but I do find the <a href="http://labs.opera.com/extensions-api/visual-guide/index.htm">visual guide to the API</a> very useful. The <a href="http://dev.opera.com/">Dev.Opera</a> article about messaging inside extensions should have included some of that love.</p>
<h3>Explain best practices</h3>
<p>Having looked through most of the example extensions, I find certain things quite interesting &#8211; and they do raise a lot of &#8220;why&#8221; type questions:</p>
<ul>
<li>Why do we need to do stuff on <code>load</code> in the background scripts?</li>
<li>How does that make a difference as compared to just executing the code in the <code>&lt;script&gt;</code> tag?</li>
<li>Do we also have to do things on <code>load</code> in the popup scripts?</li>
<li>Why do some examples check for existence of <code>opera.extension</code>? When it might not be available?</li>
<li>What are the &#8220;dos&#8221; and &#8220;donts&#8221; for the background process? What are the limitations? Considering that it&#8217;s a page that&#8217;s always active, I&#8217;m sure there are plenty.</li>
</ul>
<p>I hope the time spent with frustration, figuring things out and writing up this article was worth it. I also hope that it&#8217;s useful for at least one other person. However, in case of the information in here is already published and the questions are already answered &#8211; please &#8211; drop me a link in the comments or <a href="http://twitter.com/dymonaz">on twitter @dymonaz</a>.</p>
	</div>

	<footer>
		<dl>
			<dt>Category:</dt>
			<dd><a href="http://www.dominykas.com/category/webbie-stuff.html" title="View all posts in Webbie stuff" rel="category tag">Webbie stuff</a></dd>

			<dt>Tags:</dt> <dd><ul><li><a href="http://www.dominykas.com/tag/extensions.html" rel="tag">extensions</a></li><li><a href="http://www.dominykas.com/tag/javascript.html" rel="tag">javascript</a></li><li><a href="http://www.dominykas.com/tag/opera.html" rel="tag">opera</a></li></ul></dd>
					</dl>
	</footer>
	
			
<!-- You can start editing here. -->


			<!-- If comments are open, but there are no comments. -->

	 

<section id="commentform">
	<h1>Leave a Reply</h1>

	
		<form action="http://www.dominykas.com/wp-comments-post.php" method="post">

		
			<p><input type="text" name="author" id="author" value="" size="22" tabindex="1" />
			<label for="author"><small>Name (required)</small></label></p>

			<p><input type="text" name="email" id="email" value="" size="22" tabindex="2" />
			<label for="email"><small>Mail (will not be published) (required)</small></label></p>

			<p><input type="text" name="url" id="url" value="" size="22" tabindex="3" />
			<label for="url"><small>Website</small></label></p>

		
		<!--<p><small><strong>XHTML:</strong> You can use these tags: <code>&lt;a href=&quot;&quot; title=&quot;&quot;&gt; &lt;abbr title=&quot;&quot;&gt; &lt;acronym title=&quot;&quot;&gt; &lt;b&gt; &lt;blockquote cite=&quot;&quot;&gt; &lt;cite&gt; &lt;code&gt; &lt;del datetime=&quot;&quot;&gt; &lt;em&gt; &lt;i&gt; &lt;q cite=&quot;&quot;&gt; &lt;strike&gt; &lt;strong&gt; </code></small></p>-->

		<p><textarea name="comment" id="comment" cols="80" rows="10" tabindex="4"></textarea></p>

		<p><button type="submit">Submit Comment</button>
		<input type="hidden" name="comment_post_ID" value="117" />
		</p>
		
		</form>

	</section>
	</article>
        
	
</section>

<footer role="contentinfo" id="contentinfo">
	<p>&copy; 2009, Dominykas Blyžė.</p>
	<p>dominykas.com is proudly powered by <a href="http://wordpress.org/">WordPress</a>.</p>
</footer>


</div>


<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
var pageTracker = _gat._getTracker("UA-1761312-1");
pageTracker._initData();
pageTracker._trackPageview();
</script>

</body>
</html>
